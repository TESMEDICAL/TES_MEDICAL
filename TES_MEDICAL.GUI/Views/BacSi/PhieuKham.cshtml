@model PhieuKhamViewModel
@inject UserManager<NhanVienYte> UserManager;
@{
    ViewData["Title"] = "Phiếu khám đang chờ";
    Layout = "~/Views/Shared/LayoutMain/MainLayout.cshtml";






}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css" />

<div class="col-12">
    <div class="block">
        <div class="block-title">
            <h2><strong>Phiếu khám</strong></h2>
        </div>

        <br />

        <div class="form-group" id="listLich">
            <div class="spinner-border spinner-border-sm"></div><span>Đang lấy dữ liệu</span>

        </div>

    </div>
</div>
<button onclick="AddRow()">Add</button>

@section scripts{
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>

    <script type="text/javascript" src="~/js/datetime.js"></script>


    <script>
        var table;
        var obj = {};
        var Clienid;
        $(document).ready(

            function () {

                ReloadPage();
                Clienid = '@Html.Raw((await UserManager.GetUserAsync(User)).Id)';

            });
      
        ////Hàm mở modal của Chi tiết đặt lịch
        function Detail(_id) {
            $.ajax({
                url: "/TiepNhan/ChiTietDatLich/",
                type: 'GET',
                data: {
                    id: _id
                },
                success: function (response) {
                    $("#myModalContent").html(response);
                    $('#myModal').modal('show');
                    $('#btSave').show();
                    $('#btupdate').hide();

                }
            });
        }
        //Mở modal edit đặt lịch
        function Edit(_id) {
            $.ajax({
                url: "/TiepNhan/Edit/",
                type: 'GET',
                data: {
                    id: _id
                },
                success: function (response) {
                    $("#myModalContent").html(response);
                    $('#myModal').modal('show');
                    $('#btSave').show();
                    $('#btupdate').hide();

                }
            });
        }
        var $id = "";
        var $modal = $('#myModal');
        var $myModalContent = $("#myModalContent");
        var $modalins = $('#myModalins');
        var $myModalContentins = $("#myModalContentins");
        var $myModalTitle = $("#myModalTitle");
        var $myModalTitleins = $("#myModalTitleins");
        $("#btSave").click(function () {

            if ($("#frm").valid()) {

                var obj = $("#frm").serialize();
                console.log(new Date(obj.NgayKham))
                $.ajax({
                    type: "POST",
                    url: "/TiepNhan/Edit",
                    dataType: "json",
                    data: obj,
                    success: function (result) {
                        $('#preloader-wrapper').toggleClass('hide');
                        if (result.status >= 1) {
                            toastr.success(result.text);
                            ReloadPage()

                        }
                        else {
                            toastr.warning(result.text);
                        }
                        ReloadPage();
                    },
                    error: function (errormessage) {
                        alert(errormessage.responseText);
                    },
                    failure: function (message) {
                        $('#preloader-wrapper').toggleClass('hide');
                    }
                });

            }
        });


        function ReloadPage() {
            $('#listLich').html('<div class="spinner-border spinner-border-sm"></div><span>Đang lấy dữ liệu</span>')

            $.ajax({
                url: '/BacSi/ReloadPage/',
                type: "GET",
                timeout: 20000,
                async: false,
                dataType: "json",

                success: function (obj) {


                    $('#listLich').html('<table id="ListTable" class="table table-striped table-bordered text-center" style="width:100%"></table >')
                    table = $('#ListTable').dataTable({
                        destroy: true,
                        data: obj,
                        columns: [
                            { data: 'STT', title: 'Số thứ tự' },
                            { data: 'HoTen', title: 'Họ tên' },
                            {
                                title: 'Thao tác',
                                data: null,
                                render: function (data) {
                                    return `<a class="btn btn-info btn-sm active" title="Khám bệnh" href="/Bacsi/KhamBenh?MaPK=${data.MaPK}"> <i class="fas fa-stethoscope" aria-hidden="true"></i></a>
                                <a class="btn btn-info btn-sm active" title="Huỷ bỏ"> <i class="fas fa-close" aria-hidden="true"></i></a>`;
                                }
                            },
                            {
                                visible: false,
                                title: 'UuTien',
                                data: null,
                                render: function (data) {
                                    return data.UuTien;
                                }
                            },
                            {
                                visible: false,
                                title: 'Khongdau',
                                data: null,
                                render: function (data) {
                                    return accents_supr(data.hoTen);
                                }
                            }


                        ],

                        "order": [[3, "asc"], [0, "asc"]],
                        "language": {
                            "lengthMenu": "Hiển thị _MENU_ kết quả mỗi trang",
                            "zeroRecords": "Không có kết quả",
                            "info": "Trang: _PAGE_ / _PAGES_",
                            "infoEmpty": "Không có yêu cầu nào",
                            "infoFiltered": "(filtered from _MAX_ total records)",
                            "search": "Tìm: ",
                            "paginate": {
                                "first": "Trang đầu",
                                "last": "Trang cuối",
                                "next": ">",
                                "previous": "<"
                            },
                        }






                    });

                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                },

            });
        }
        setInterval(function () {
            var temp = $('#ListTable_filter').find('input[type=search]').val();



            $.ajax({
                url: '/BacSi/ReloadPage/',
                type: "GET",
                timeout: 20000,
                async: false,
                dataType: "json",

                success: function (obj) {


                  
                    table = $('#ListTable').dataTable({
                        destroy: true,
                        data: obj,
                        columns: [
                            { data: 'STT', title: 'Số thứ tự' },
                            { data: 'HoTen', title: 'Họ tên' },
                            {
                                title: 'Thao tác',
                                data: null,
                                render: function (data) {
                                    return `<a class="btn btn-info btn-sm active" title="Khám bệnh" href="/Bacsi/KhamBenh?MaPK=${data.MaPK}"> <i class="fas fa-stethoscope" aria-hidden="true"></i></a>
                                <a class="btn btn-info btn-sm active" title="Huỷ bỏ"> <i class="fas fa-close" aria-hidden="true"></i></a>`;
                                }
                            },
                            {
                                visible: false,
                                title: 'UuTien',
                                data: null,
                                render: function (data) {
                                    return data.UuTien;
                                }
                            },
                            {
                                visible: false,
                                title: 'Khongdau',
                                data: null,
                                render: function (data) {
                                    return accents_supr(data.hoTen);
                                }
                            }


                        ],

                        "order": [[3, "asc"], [0, "asc"]],
                        "language": {
                            "lengthMenu": "Hiển thị _MENU_ kết quả mỗi trang",
                            "zeroRecords": "Không có kết quả",
                            "info": "Trang: _PAGE_ / _PAGES_",
                            "infoEmpty": "Không có yêu cầu nào",
                            "infoFiltered": "(filtered from _MAX_ total records)",
                            "search": "Tìm: ",
                            "paginate": {
                                "first": "Trang đầu",
                                "last": "Trang cuối",
                                "next": ">",
                                "previous": "<"
                            },
                        }

                     



                    }).ajax.reload(null, false);
                   

                },
                error: function (errormessage) {
                    alert(errormessage.responseText);
                },

            })
         $('#ListTable_filter').find('input[type=search]').val();
        }, 5000);


        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/PhieuKham")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
            } catch (err) {
                console.log(err);
                setTimeout(start, 5000);
            }
        };

        connection.onclose(async () => {
            await start();
        });

        // Start the connection.
        start();


        connection.on("SentDocTor", (id,obj) => {

            if (Clienid == id) {

                toastr.success("Có một lịch đặt mới");
                console.log(obj.maPK)
           


              
          
            }


        });
     



    </script>
}

