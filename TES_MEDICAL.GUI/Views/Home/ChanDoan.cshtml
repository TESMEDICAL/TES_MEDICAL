
@{
    ViewData["Title"] = "CHẨN ĐOÁN";
    Layout = "~/Views/Shared/GuestLayout.cshtml";
}
<link rel="stylesheet" href="~/font-awesome-4.7/font-awesome-4.7/css/font-awesome.min.css">
<style>

    .ui-autocomplete {
        position: absolute;
        z-index: 1000;
        display: none;
        float: left;
        min-width: 160px;
        /* padding: 5px 0;
            margin: 2px 0 0;*/
        list-style: none;
        font-size: 14px;
        text-align: left;
        background-color: #ffffff;
        border: 1px solid #cccccc;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        background-clip: padding-box;
    }

    .title {
        margin-top: 20px;
    }

    .test .test-detail {
        margin-bottom: 2%;
    }

        .test .test-detail .test-head {
            background-color: rgb(228, 228, 228);
        }

        .test .test-detail .test-body {
            padding-left: 10%;
        }

        .test .test-detail .test-body-1 {
            padding-inline: 10%;
        }

    .test-body .test-body-item {
        margin-top: 5%;
    }

    .btn-select {
        width: 180px;
        height: 50px;
        background-color: rgb(10, 154, 115);
        color: white;
    }

    .test-foot {
        margin-top: 10px;
    }

        .test-foot .test-foot-btn button {
            width: 150px;
            height: 40px;
            background-color: rgb(10, 154, 115);
            color: white;
        }

    .test .test-result {
        margin-top: 2%;
    }

        .test .test-result .test-head {
            background-color: rgb(228, 228, 228);
        }

    .btn-contact {
        width: 230px;
        height: 50px;
        background-color: rgb(245, 249, 250);
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        position: relative;
    }

    .result-btn .btn-booking {
        width: 230px;
        height: 50px;
        background-color: rgb(10, 154, 115);
        color: white;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    }

    .btn-disease {
        width: 230px;
        height: 50px;
        background-color: rgb(10, 154, 115);
        color: white;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    }

    .modal-dialog {
        margin-top: 50px;
    }

    .symptom-list .symptom-item {
        display: flex;
        /*        border: 1px solid gray;
    */
    }

        .symptom-list .symptom-item p {
            width: 80%;
            margin: 0 20px 0 0;
            font-size: 20px;
            flex-wrap: wrap;
        }

        .symptom-list .symptom-item img {
            width: 7px;
            height: 7px;
            margin: 14px 10px 0 5px;
        }

    .symptom-item button {
        padding-top: 2px;
        float: right;
        background: none;
    }

        .symptom-item button i {
            font-size: 20px;
            color: #ff002b;
        }

        .symptom-item button:hover {
            transform: scale(1.075);
            font-size: 20px;
            color: #ff002b;
            float: right;
        }
</style>
<!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
<![endif]-->
<!-- Add your site or application content here -->
<!-- Body main wrapper start -->
<div class="body-wrapper">
    <!-- LOGIN AREA START (Register) -->
    <div class="ltn__login-area pb-110">
        <div class="container">
            <div class="col-12">
                <div class="title text-center">
                    <h2>CHẨN ĐOÁN</h2>
                </div>
                <br>
                <div class="test">
                    <div class="test-detail border">
                        <div class="test-head d-flex justify-content-start" style="background-color: rgb(228, 228, 228); height: 50px;">
                            <div class="bd-highlight" style="margin-top: 10px; margin-left: 10px;"><p>Các triệu chứng cơ bản bạn đang mắc phải: </p></div>
                        </div>
                        <div class="test-body-1 row">
                            <div class="test-body-left d-flex">
                                <div class="w-100">
                                    <input type="text" style="height: 50px;" id="trieuchungauto" placeholder="Nhập triệu chứng đang mắc phải ..." class="form-control mt-4" />
                                </div>
                                <div class="text-end">
                                    <button class="btn-select mt-4 ms-5 float-end">Thêm vào danh sách</button>
                                </div>
                            </div>
                            <div class="test-body-right">
                                <div class="mt-4" style="border: 1px solid #dee2e6; overflow: scroll; overflow-x: hidden; height: 180px; ">
                                    @*<ul class="symptom-list mt-2 ms-4 me-4" id="ListTrieuChung">
                                            <li><span name="trieuchungOld"></span> <i class="fa fa-trash" aria-hidden="true"></i></li>

                                        </ul>*@
                                    <div class="symptom-list row m-3" id="ListTrieuChung">
                                        @*<div class="symptom-item col-sm-4">
                                                <img src="~/GuestElement/img/circle_PNG17.png" />
                                                <p>
                                                    Ho
                                                </p>
                                                <button><i class="fa fa-trash removeTC" aria-hidden="true"></i></button>
                                            </div>*@

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="test-foot d-flex justify-content-end">
                            <!-- <div class="p-2 bd-highlight">C</div> -->
                            <div class="test-foot-btn p-2 bd-highlight"><button onclick="GetTrieuChungNew()">Tiếp theo</button></div>
                        </div>
                    </div>
                    <div class="col-2 m-auto mt-5 bg-light" style="border-radius: 10px; box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;"><p class="text-center p-2 text-secondary"><i class="fa fa-circle-o-notch fa-spin" style="font-size:15px"></i> Đang tải dữ liệu</p></div>
                    <div class="test-detail border">
                        <div class="test-head d-flex justify-content-start" style="background-color: rgb(228, 228, 228); height: 50px;">
                            <div class="bd-highlight" style="margin-top: 10px; margin-left: 10px;"><p>Các triệu chứng liên quan: </p></div>
                        </div>
                        <div class="test-body row">
                            <div class="test-body-item col-sm-4 row">
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Ho
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Sốt
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Tê mỏi tay chân
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Đau đầu
                                </label>
                            </div>
                            <div class="test-body-item col-sm-4 row">
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Ho
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Sốt
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Tê mỏi tay chân
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Đau đầu
                                </label>
                            </div>
                            <div class="test-body-item col-sm-4 row">
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Ho
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Sốt
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Tê mỏi tay chân
                                </label>
                                <label class="checkbox-inline" style="font-size: 20px;">
                                    <input type="checkbox" value=""> Đau đầu
                                </label>
                            </div>
                        </div>
                        <div class="test-foot d-flex justify-content-end">
                            <!-- <div class="p-2 bd-highlight">C</div> -->
                            <div class="test-foot-btn p-2 bd-highlight"><button>Hoàn tất</button></div>
                        </div>
                    </div>
                    <div class="test-result border">
                        <div class="test-head d-flex justify-content-start" style="height: 50px;">
                            <div class="bd-highlight" style="margin-top: 10px; margin-left: 10px;"><p>Kết quả trả về: </p></div>
                        </div>
                        <div class="result-body row">
                            <div class="d-flex justify-content-start">
                                <div class="bd-highlight" style="padding: 10px 20px 10px 30px;">
                                    <p style="font-size: 20px;">
                                        Dựa theo các triệu chứng mà bạn cung cấp,
                                        chúng tôi đưa ra kết quả như sau:
                                    </p>
                                </div>
                            </div>
                            <div class="result-content col-sm-9 ">
                                <div class="row" style="padding: 10px 20px 10px 30px;">
                                    <!--Tên bệnh-->
                                    <p style="font-size: 30px; font-weight: 600;">Tên bệnh</p>

                                    <!--Có thể xài thẻ <p> hoặc button để mở modal => modal chứa thông tin bệnh -->
                                    <p style="font-size: 20px;">
                                        Thông tin bệnh:
                                        <!--Thông tin bệnh sẽ thêm ở đây-->
                                    </p>
                                    <!--Modal thông tin bệnh -->
                                    <button type="button" class="btn-disease w-25" style="margin-left: 10px;" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                        Thông tin bệnh
                                    </button>
                                </div>
                            </div>
                            <!-- <div class="d-flex p-2 bd-highlight row"> -->
                            <div class="result-btn col-sm-3">
                                <div class="row p-4">
                                    <button class="btn-contact mb-2"><i class="fa fa-phone" aria-hidden="true"></i> Liên hệ ngay</button>
                                    <button class="btn-booking"><i class="fa fa-calendar" aria-hidden="true"></i> Đặt lịch khám</button>
                                </div>
                            </div>
                        </div>
                        <!--Phần modal Thông tin bệnh-->
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header" style="border-bottom: 1px solid lightgray;">
                                        <p style="font-size: 25px; margin: 10px 20px 10px 20px;">Thông tin bệnh</p>
                                    </div>
                                    <div class="modal-body" style="overflow: scroll; overflow-x: hidden; height: 400px;">
                                        Nội dung
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" style="height: 40px; width: 100px; background-color: darkgray" data-bs-dismiss="modal">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- LOGIN AREA END -->


</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
@section Scripts{


    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="~/js/datetime.js"></script>

    <script>
        var ListTrieuChung = [];
        $(document).ready(


            function () {

                $('#yellow-trigger').click(function () {
                    $('#red-box').hide();
                    $('#yellow-box').fadeIn('slow');
                });

                $('#red-trigger').click(function () {
                    $('#yellow-box').hide();
                    $('#red-box').fadeIn('slow');
                });


                /* Need jquery to be extended with code snippet for selectrange i found somewhere, but forgot where...: */

                $("#trieuchungauto").autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: '/api/chandoan/searchtrieuchung',
                            headers: {
                                "RequestVerificationToken":
                                    $('input[name="__RequestVerificationToken"]').val()
                            },
                            data: { "term": request.term },
                            dataType: "json",
                            success: function (data) {
                                response($.map(data, function (item) {
                                    return item;
                                }))
                            },
                            error: function (xhr, textStatus, error) {
                                alert(xhr.statusText);
                            },
                            failure: function (response) {
                                alert("failure " + response.responseText);
                            }
                        });
                    },
                 /*   focus: function () { return false; },*/
                    open: function (event, ui) {
                        var firstElement = $(this).data("uiAutocomplete").menu.element[0].children[0]
                            , inpt = $(this)
                            , original = inpt.val()
                            , firstElementText = $(firstElement).text();

                        /*
                           here we want to make sure that we're not matching something that doesn't start
                           with what was typed in
                        */

                        if (accents_supr(firstElementText).toLowerCase().indexOf(accents_supr(original).toLowerCase()) === 0) {
                            inpt.val(firstElementText);//change the input to the first match

                            inpt[0].selectionStart = original.length; //highlight from end of input
                            inpt[0].selectionEnd = firstElementText.length;//highlight to the end
                        }
                    }
                });

                $('#trieuchungauto').on("keyup", function (e) {
                    if (e.keyCode == 13) {
                        addTrieuChung($(this).val());
                        $(this).val("");
                    }
                });



            });

        function addTrieuChung(name) {
            $('#ListTrieuChung').append(`<div class="symptom-item col-sm-6 trieuChungOld">
                                            <img src="~/GuestElement/img/circle_PNG17.png" />
                                            <p name="TenTrieuChung">${name}</p>
                                            <button><i class="fa fa-trash removeTC" aria-hidden="true"></i></button>
                                        </div>`)
            $('#trieuchungauto').val("");
        }




        $(document).on('click', '.remove', function () {
            $(this).parent().remove();


        });

        $(document).on('click', '.removeTC', function () {
            $(this).parent().parent().remove();


        });

        //Hàm mở modal của Xác nhận kết quả
        function GetTrieuChungNew() {
            ListTrieuChung =[];

            $(".trieuChungOld").each(function () {



                ListTrieuChung.push($(this).find("[name='TenTrieuChung']").html());

                });


            console.log(ListTrieuChung);


            $.ajax({
                url: "/api/ChanDoan/GetTrieuChungNew",
                type: 'Post',
                data: {
                    ListTrieuChung : ListTrieuChung

                }

                       ,
                    success: function (response) {
                        console.log(response)



                    }
                });
            }


        $(document).on('click', '.addThuoc', function () {

            $tr = $(this).parent().parent();
            var $td = $tr.find("td");
            console.log($td.eq(2).text());
            $("#listToaThuoc").append(`<tr>
                        <th class="col-8">
                              <input style="display:none" name="MaThuoc" value="${$td.eq(2).text()}"  />
                            <h6 style="margin-inline: 20px; font-weight:bold;" name ="TenThuoc" >${$td.eq(0).text()}</h6>
                            <div class="row" style="margin-inline: 20px;">
                                <div class="mb-2 col-sm-4">
                                    <label for="">Ngày uống <input style="width: 25%" type="number" class="form-control;" name="LanTrongNgay" > lần.</label>
                                </div>
                                <div class="mb-2 col-sm-4">
                                    <label for="">Mỗi lần <input style="width: 25%" type="number" class="form-control;" name="VienMoiLan"> viên.</label>
                                </div>
                                <div class="form-check col-sm-4 mb-2">
                                    <input class="form-check-input" type="checkbox" name ="TruocKhian" value="" >
                                    <label class="form-check-label" for="flexCheckChecked">
                                        Uống trước khi ăn
                                    </label>
                                </div>
                                <div class="form-check col-sm-4 mb-2">
                                    <input class="form-check-input" type="checkbox" value="" name ="Sang" checked>
                                    <label class="form-check-label" for="flexCheckChecked">
                                        Uống sáng
                                    </label>
                                </div>
                                <div class="form-check col-sm-4 mb-2">
                                    <input class="form-check-input" type="checkbox" value="" name ="Trua" checked>
                                    <label class="form-check-label" for="flexCheckChecked">
                                        Uống trưa
                                    </label>
                                </div>
                                <div class="form-check col-sm-4 mb-2">
                                    <input class="form-check-input" type="checkbox" value="" name ="Chieu" checked>
                                    <label class="form-check-label" for="flexCheckChecked">
                                        Uống tối
                                    </label>
                                </div>
                            </div>
                        </th>
                        <th class="col-2">
                            <div class="input-group mb-3">
                                <input type="number"  placeholder="Số lượng..." class="form-control" name ="SoLuong">
                            </div>
                        </th>
                        <th class="col-2 text-center"><button class="btn btn-danger deleteThuoc"><i class="fa fa-trash"></i></button></th>
                    </tr>
              `);
            table
                .row($(this).parents('tr'))
                .remove()
                .draw();
        });

        $(document).on('click', '.deleteThuoc', function () {
            $tr = $(this).parent().parent();

            var rowNode = table.row.add([$tr.find("[name='TenThuoc']").html(), `<button class="btn btn-success btn-sm addThuoc" style="border-radius: 60px;"><i class="fas fa-plus"></i></button> | <button class="btn-info btn btn-sm active " onclick="_Detail('${$tr.find("[name='MaThuoc']").val()}')" style="border-radius: 60px;"><i class="fa fa-info-circle" ></i></button>`, $tr.find("[name='MaThuoc']").val()]).draw().node();


            $(rowNode).find('td').eq(1).addClass('text-center');
            $(rowNode).find('td').eq(2).addClass('d-none');

            $tr.remove();

        });


        function ConfirmToaThuoc() {
            listCTThuoc = [];
            $('#toathuocFinal').html("");
            $("#listToaThuoc > tr").each(function () {
                var thuoc = {};
                thuoc.MaPK = $('#MaPK').val();
                thuoc.MaThuoc = $(this).find("[name='MaThuoc']").val();
                thuoc.TenThuoc = $(this).find("[name='TenThuoc']").html();
                thuoc.SoLuong = $(this).find("[name='SoLuong']").val();
                thuoc.LanTrongNgay = $(this).find("[name='LanTrongNgay']").val();
                thuoc.VienMoiLan = $(this).find("[name='VienMoiLan']").val();
                if ($(this).find("[name='TruocKhian']").is(":checked")) {
                    thuoc.TruocKhian = true
                } else { thuoc.TruocKhian = false; }
                if ($(this).find("[name='Sang']").is(":checked")) {
                    thuoc.Sang = true
                } else { thuoc.Sang = false; }
                if ($(this).find("[name='Trua']").is(":checked")) {
                    thuoc.Trua = true
                } else { thuoc.Trua = false; }
                if ($(this).find("[name='Chieu']").is(":checked")) {
                    thuoc.Chieu = true
                } else { thuoc.Chieu = false; }

                listCTThuoc.push(thuoc)

                $("#toathuocFinal").append(` <tr>
                            <td class="col-8">
                                <h6 style="font-weight: bold">${thuoc.TenThuoc}</h6>
                                @*Thẻ <p style="font-style: italic"></p> này mô tả, gắn dữ liệu vào có thể xóa*@
                                <p style="font-style: italic"> Ngày uống ${thuoc.LanTrongNgay} lần, mỗi lần ${thuoc.VienMoiLan} viên, uống ${thuoc.TruocKhian?"trước khi ăn":"sau khi ăn"}, uống ${thuoc.Sang ? "sáng" : ""} ${thuoc.Trua ? ", trưa" : ""} ${thuoc.Chieu ? ", chiều" : ""}.</p>
                            </td>
                            <td class="col-2 text-center">${thuoc.SoLuong}</td>

                        </tr>`);



            });

        }

        $("#btSend").click(function () {

            $(this).prop("disabled", true);

            $(this).html(
                '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span> Waiting</span>'
            );
            $.ajax({
                type: "POST",
                url: "/Bacsi/ThemToa/",
                data: {
                    model: Phieukham,
                    ListTrieuChung: ListTrieuChung

                },
                success: function (result) {
                    $('#preloader-wrapper').toggleClass('hide');

                    if (result.status >= 1) {

                        let timerInterval
                        Swal.fire({
                            title: 'Gửi toa  thành công',

                            html: '<progress value="0" max="3" id="progressBar"></progress>',
                            timer: 3000,
                            timerProgressBar: true,
                            didOpen: () => {
                                Swal.showLoading()
                                timerInterval = setInterval(() => {
                                    const content = Swal.getHtmlContainer()
                                    if (content) {
                                        const b = content.querySelector('#progressBar')
                                        if (b) {
                                            b.value = 3 - Math.floor(Swal.getTimerLeft() / 1000)
                                        }
                                    }
                                }, 100)
                            },
                            willClose: () => {
                                clearInterval(timerInterval)
                                window.location.href = result.redirectUrL;
                            }
                        }).then((cf) => {

                            if (cf.dismiss === Swal.DismissReason.timer) {
                                window.location.href = result.redirectUrL;
                            }
                        })
                    }
                    else {
                        toastr.warning(result.text);
                        $(this).prop("disabled", false);

                        $(this).html(
                            'Retry');
                    }

                },
                error: function (errormessage) {
                    //alert(errormessage.responseText);
                    $(this).prop("disabled", false);

                    $(this).html(
                        'Retry');
                },
                failure: function (message) {
                    $('#preloader-wrapper').toggleClass('hide');
                }
            });


        });


    </script>
}


